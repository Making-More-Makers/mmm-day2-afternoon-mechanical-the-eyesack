# GitHub Classroom File Validation for Day 2 Afternoon Assignment
# Day 2 ä¸‹åˆä½œä¸šçš„ GitHub Classroom æ–‡ä»¶éªŒè¯

name: File Validation for Mechanical Assignment
on:
  push:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  file-validation:
    name: Validate Submission Files
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout student repository
        uses: actions/checkout@v4
      
      - name: Validate submission structure
        id: validate
        run: |
          echo "ğŸ” Checking submission files..."
          echo "================================"
          
          # Initialize counters
          ERRORS=0
          WARNINGS=0
          
          # Function to report error
          error() {
            echo "âŒ ERROR: $1"
            ERRORS=$((ERRORS + 1))
          }
          
          # Function to report warning
          warning() {
            echo "âš ï¸ WARNING: $1"
            WARNINGS=$((WARNINGS + 1))
          }
          
          # Function to report success
          success() {
            echo "âœ… $1"
          }
          
          # Check submission.json
          echo ""
          echo "ğŸ“„ Checking submission.json..."
          if [ ! -f "submission.json" ]; then
            error "submission.json not found"
          else
            success "submission.json exists"
            
            # Check if it's valid JSON
            if ! python3 -c "import json; json.load(open('submission.json'))" 2>/dev/null; then
              error "submission.json is not valid JSON"
            else
              success "submission.json is valid JSON"
              
              # Check required fields
              STUDENT_NAME=$(python3 -c "import json; print(json.load(open('submission.json')).get('student_name', ''))" 2>/dev/null)
              if [ -z "$STUDENT_NAME" ] || [ "$STUDENT_NAME" = "Your Name" ] || [ "$STUDENT_NAME" = "" ]; then
                warning "student_name is not filled in submission.json"
              else
                success "student_name filled: $STUDENT_NAME"
              fi
            fi
          fi
          
          # Check A_LaserCut folder
          echo ""
          echo "ğŸ“ Checking A_LaserCut/ folder..."
          if [ ! -d "A_LaserCut" ]; then
            error "A_LaserCut/ folder not found"
          else
            success "A_LaserCut/ folder exists"
            
            # Check for design source files (.ai or .svg)
            SOURCE_FILES=$(find A_LaserCut -maxdepth 1 -type f \( -iname "*.ai" -o -iname "*.svg" \) | wc -l)
            if [ "$SOURCE_FILES" -eq 0 ]; then
              error "No design source file (.ai or .svg) found in A_LaserCut/"
            elif [ "$SOURCE_FILES" -gt 1 ]; then
              warning "Multiple source files found (expected 1): $SOURCE_FILES files"
              find A_LaserCut -maxdepth 1 -type f \( -iname "*.ai" -o -iname "*.svg" \)
            else
              success "Design source file found: $(find A_LaserCut -maxdepth 1 -type f \( -iname "*.ai" -o -iname "*.svg" \))"
            fi
            
            # Check for DXF export file
            DXF_FILES=$(find A_LaserCut -maxdepth 1 -type f -iname "*.dxf" | wc -l)
            if [ "$DXF_FILES" -eq 0 ]; then
              error "No DXF export file found in A_LaserCut/"
            elif [ "$DXF_FILES" -gt 1 ]; then
              warning "Multiple DXF files found (expected 1): $DXF_FILES files"
            else
              DXF_FILE=$(find A_LaserCut -maxdepth 1 -type f -iname "*.dxf")
              success "DXF export file found: $(basename "$DXF_FILE")"
              
              # Check DXF file size
              DXF_SIZE=$(stat -f%z "$DXF_FILE" 2>/dev/null || stat -c%s "$DXF_FILE" 2>/dev/null)
              DXF_SIZE_KB=$((DXF_SIZE / 1024))
              if [ "$DXF_SIZE" -lt 100 ]; then
                warning "DXF file is very small (${DXF_SIZE} bytes) - might be empty"
              else
                success "DXF file size: ${DXF_SIZE_KB} KB"
              fi
            fi
            
            # Check for README_LaserCut.md
            if [ ! -f "A_LaserCut/README_LaserCut.md" ]; then
              error "README_LaserCut.md not found in A_LaserCut/"
            else
              success "README_LaserCut.md exists"
              
              # Check README size
              README_SIZE=$(stat -f%z "A_LaserCut/README_LaserCut.md" 2>/dev/null || stat -c%s "A_LaserCut/README_LaserCut.md" 2>/dev/null)
              if [ "$README_SIZE" -lt 200 ]; then
                warning "README_LaserCut.md is very short (${README_SIZE} bytes)"
              else
                success "README_LaserCut.md size: ${README_SIZE} bytes"
              fi
            fi
            
            # Check for photos
            PHOTO_COUNT=$(find A_LaserCut -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.heic" -o -iname "*.webp" \) | wc -l)
            if [ "$PHOTO_COUNT" -eq 0 ]; then
              error "No photos found in A_LaserCut/ (required: at least 2)"
            elif [ "$PHOTO_COUNT" -eq 1 ]; then
              warning "Only 1 photo found in A_LaserCut/ (recommended: at least 2)"
            else
              success "$PHOTO_COUNT photos found in A_LaserCut/"
            fi
          fi
          
          # Check B_3DModel folder
          echo ""
          echo "ğŸ“ Checking B_3DModel/ folder..."
          if [ ! -d "B_3DModel" ]; then
            error "B_3DModel/ folder not found"
          else
            success "B_3DModel/ folder exists"
            
            # Check for STL file
            STL_FILES=$(find B_3DModel -maxdepth 1 -type f -iname "*.stl" | wc -l)
            if [ "$STL_FILES" -eq 0 ]; then
              error "No STL file found in B_3DModel/"
            elif [ "$STL_FILES" -gt 1 ]; then
              warning "Multiple STL files found (expected 1): $STL_FILES files"
            else
              STL_FILE=$(find B_3DModel -maxdepth 1 -type f -iname "*.stl")
              success "STL file found: $(basename "$STL_FILE")"
              
              # Check STL file size
              STL_SIZE=$(stat -f%z "$STL_FILE" 2>/dev/null || stat -c%s "$STL_FILE" 2>/dev/null)
              STL_SIZE_KB=$((STL_SIZE / 1024))
              if [ "$STL_SIZE" -lt 1000 ]; then
                warning "STL file is very small (${STL_SIZE} bytes) - might be empty or too simple"
              elif [ "$STL_SIZE" -gt 10485760 ]; then
                warning "STL file is very large (${STL_SIZE_KB} KB) - might be too complex"
              else
                success "STL file size: ${STL_SIZE_KB} KB"
              fi
            fi
            
            # Check for README_3DPrint.md
            if [ ! -f "B_3DModel/README_3DPrint.md" ]; then
              error "README_3DPrint.md not found in B_3DModel/"
            else
              success "README_3DPrint.md exists"
              
              # Check README size
              README_SIZE=$(stat -f%z "B_3DModel/README_3DPrint.md" 2>/dev/null || stat -c%s "B_3DModel/README_3DPrint.md" 2>/dev/null)
              if [ "$README_SIZE" -lt 200 ]; then
                warning "README_3DPrint.md is very short (${README_SIZE} bytes)"
              else
                success "README_3DPrint.md size: ${README_SIZE} bytes"
              fi
            fi
            
            # Check for photos
            PHOTO_COUNT=$(find B_3DModel -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.heic" -o -iname "*.webp" \) | wc -l)
            if [ "$PHOTO_COUNT" -eq 0 ]; then
              error "No photos/screenshots found in B_3DModel/ (required: at least 2)"
            elif [ "$PHOTO_COUNT" -eq 1 ]; then
              warning "Only 1 photo found in B_3DModel/ (recommended: at least 2)"
            else
              success "$PHOTO_COUNT photos/screenshots found in B_3DModel/"
            fi
            
            # Check for optional Tinkercad link
            if [ -f "B_3DModel/tinkercad_link.txt" ]; then
              success "tinkercad_link.txt found (optional, bonus!)"
            fi
          fi
          
          # Summary
          echo ""
          echo "================================"
          echo "ğŸ“Š VALIDATION SUMMARY"
          echo "================================"
          echo "Errors: $ERRORS"
          echo "Warnings: $WARNINGS"
          
          # Save results for next step
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
          
          # Exit with error if there are critical errors
          if [ "$ERRORS" -gt 0 ]; then
            echo ""
            echo "âŒ Validation failed with $ERRORS error(s)"
            echo "Please fix the errors above and push again."
            exit 1
          else
            echo ""
            echo "âœ… All required files found!"
            if [ "$WARNINGS" -gt 0 ]; then
              echo "âš ï¸ But there are $WARNINGS warning(s) to review"
            fi
          fi
      
      - name: Create feedback issue
        if: always()
        uses: actions/github-script@v7
        env:
          ERRORS: ${{ steps.validate.outputs.errors }}
          WARNINGS: ${{ steps.validate.outputs.warnings }}
        with:
          script: |
            const fs = require('fs');
            const errors = process.env.ERRORS || '0';
            const warnings = process.env.WARNINGS || '0';
            
            let status = '';
            let emoji = '';
            let summary = '';
            
            if (errors === '0') {
              status = 'âœ… Validation Passed';
              emoji = 'âœ…';
              summary = 'All required files are present! Great work organizing your submission.';
            } else {
              status = 'âŒ Validation Failed';
              emoji = 'âŒ';
              summary = `Found ${errors} error(s) that need to be fixed before your submission is complete.`;
            }
            
            const feedback = `# ${emoji} File Validation Results | æ–‡ä»¶éªŒè¯ç»“æœ
            
            > **Assignment**: Day 2 Afternoon - Laser Cutting + 3D Printing  
            > **ä½œä¸š**: ç¬¬2å¤©ä¸‹åˆ - æ¿€å…‰åˆ‡å‰² + 3D æ‰“å°  
            > **Validation Date**: ${new Date().toISOString().split('T')[0]}  
            > **éªŒè¯æ—¥æœŸ**: ${new Date().toISOString().split('T')[0]}
            
            ---
            
            ## ğŸ“Š Status | çŠ¶æ€
            
            **${status}**
            
            ${summary}
            
            ${summary}
            
            **Errors | é”™è¯¯**: ${errors}  
            **Warnings | è­¦å‘Š**: ${warnings}
            
            ---
            
            ## ğŸ“‹ Detailed Results | è¯¦ç»†ç»“æœ
            
            Check the Actions tab for full validation log:
            
            æŸ¥çœ‹ Actions æ ‡ç­¾ä»¥è·å–å®Œæ•´éªŒè¯æ—¥å¿—ï¼š
            
            ğŸ‘‰ [View full validation log](${context.payload.repository.html_url}/actions/runs/${context.runId})
            
            ---
            
            ## ğŸ“ Required Files Checklist | å¿…éœ€æ–‡ä»¶æ£€æŸ¥æ¸…å•
            
            ### Task A: Laser Cutting | ä»»åŠ¡ Aï¼šæ¿€å…‰åˆ‡å‰²
            
            - \`submission.json\` - Submission info (æäº¤ä¿¡æ¯)
            - \`A_LaserCut/\` folder (æ–‡ä»¶å¤¹)
              - Design source: \`.ai\` OR \`.svg\` file (è®¾è®¡æºæ–‡ä»¶)
              - Export: \`.dxf\` file (å¯¼å‡ºæ–‡ä»¶)
              - \`README_LaserCut.md\` - Documentation (æ–‡æ¡£)
              - Photos: At least 2 images (ç…§ç‰‡ï¼šè‡³å°‘ 2 å¼ å›¾ç‰‡)
            
            ### Task B: 3D Printing | ä»»åŠ¡ Bï¼š3D æ‰“å°
            
            - \`B_3DModel/\` folder (æ–‡ä»¶å¤¹)
              - Model: \`.stl\` file (æ¨¡å‹æ–‡ä»¶)
              - \`README_3DPrint.md\` - Documentation (æ–‡æ¡£)
              - Photos: At least 2 screenshots (ç…§ç‰‡ï¼šè‡³å°‘ 2 å¼ æˆªå›¾)
              - \`tinkercad_link.txt\` - Optional (å¯é€‰)
            
            ---
            
            ## ğŸ”§ Common Issues | å¸¸è§é—®é¢˜
            
            ${errors !== '0' ? `
            ### If files are missing | å¦‚æœæ–‡ä»¶ç¼ºå¤±:
            
            1. **Check folder names** - Must be exactly \`A_LaserCut\` and \`B_3DModel\` (æ£€æŸ¥æ–‡ä»¶å¤¹åç§°)
            2. **Check file extensions** - \`.dxf\` for laser cutting, \`.stl\` for 3D printing (æ£€æŸ¥æ–‡ä»¶æ‰©å±•å)
            3. **Check README files** - Must be named exactly \`README_LaserCut.md\` and \`README_3DPrint.md\` (æ£€æŸ¥ README æ–‡ä»¶å)
            4. **Check photo formats** - Supported: .jpg, .jpeg, .png, .heic, .webp (æ£€æŸ¥ç…§ç‰‡æ ¼å¼)
            5. **Git add and commit** - Make sure you added all files to Git (ç¡®ä¿æ·»åŠ æ‰€æœ‰æ–‡ä»¶åˆ° Git)
            
            \`\`\`bash
            # Example: Add all files and push
            git add A_LaserCut/ B_3DModel/ submission.json
            git commit -m "Add all required files"
            git push origin main
            \`\`\`
            ` : ''}
            
            ${warnings !== '0' ? `
            ### Warnings to review | éœ€è¦æ£€æŸ¥çš„è­¦å‘Š:
            
            - Check the Actions log for specific warnings (æŸ¥çœ‹ Actions æ—¥å¿—äº†è§£å…·ä½“è­¦å‘Š)
            - Warnings won't prevent submission but may affect grading (è­¦å‘Šä¸ä¼šé˜»æ­¢æäº¤ä½†å¯èƒ½å½±å“è¯„åˆ†)
            - Consider fixing warnings for a better submission (è€ƒè™‘ä¿®å¤è­¦å‘Šä»¥è·å¾—æ›´å¥½çš„æäº¤)
            ` : ''}
            
            ---
            
            ## ğŸ“š Resources | èµ„æº
            
            - [README.md](./README.md) - Full assignment instructions (å®Œæ•´ä½œä¸šè¯´æ˜)
            - [DESIGN-GUIDE.md](./DESIGN-GUIDE.md) - Design tutorials and rules (è®¾è®¡æ•™ç¨‹å’Œè§„åˆ™)
            - [SUBMISSION.md](./SUBMISSION.md) - Submission requirements (æäº¤è¦æ±‚)
            - [HOW-TO-SUBMIT.md](./HOW-TO-SUBMIT.md) - Step-by-step guide (åˆ†æ­¥æŒ‡å—)
            - [rubric.md](./rubric.md) - Grading criteria (è¯„åˆ†æ ‡å‡†)
            
            ---
            
            ## ğŸ’¬ Need Help? | éœ€è¦å¸®åŠ©ï¼Ÿ
            
            ${errors !== '0' ? `
            **Your submission has errors that need to be fixed.**
            
            **ä½ çš„æäº¤æœ‰éœ€è¦ä¿®å¤çš„é”™è¯¯ã€‚**
            
            1. Read the error messages in the Actions log (é˜…è¯» Actions æ—¥å¿—ä¸­çš„é”™è¯¯æ¶ˆæ¯)
            2. Fix the issues (ä¿®å¤é—®é¢˜)
            3. Commit and push again (å†æ¬¡æäº¤å¹¶æ¨é€)
            4. The validation will run automatically (éªŒè¯å°†è‡ªåŠ¨è¿è¡Œ)
            
            If you're stuck:
            - Check [HOW-TO-SUBMIT.md](./HOW-TO-SUBMIT.md) for detailed instructions (æŸ¥çœ‹è¯¦ç»†è¯´æ˜)
            - Ask your instructor or TAs for help (å‘è®²å¸ˆæˆ–åŠ©æ•™å¯»æ±‚å¸®åŠ©)
            - Review the submission structure in README.md (æŸ¥çœ‹ README.md ä¸­çš„æäº¤ç»“æ„)
            ` : `
            **Great job! Your files are properly organized.**
            
            **å¹²å¾—å¥½ï¼ä½ çš„æ–‡ä»¶ç»„ç»‡å¾—å¾ˆå¥½ã€‚**
            
            ${warnings !== '0' ? `
            Review the warnings to make your submission even better:
            - Some files might be incomplete (æŸäº›æ–‡ä»¶å¯èƒ½ä¸å®Œæ•´)
            - Consider adding more documentation or photos (è€ƒè™‘æ·»åŠ æ›´å¤šæ–‡æ¡£æˆ–ç…§ç‰‡)
            ` : ''}
            
            Your instructor will review the content quality for final grading.
            
            è®²å¸ˆå°†å®¡æŸ¥å†…å®¹è´¨é‡ä»¥è¿›è¡Œæœ€ç»ˆè¯„åˆ†ã€‚
            `}
            
            ---
            
            ## ğŸ”„ Resubmission | é‡æ–°æäº¤
            
            This validation runs automatically on every push. If you need to make changes:
            
            æ­¤éªŒè¯åœ¨æ¯æ¬¡æ¨é€æ—¶è‡ªåŠ¨è¿è¡Œã€‚å¦‚æœéœ€è¦è¿›è¡Œæ›´æ”¹ï¼š
            
            1. Make your changes locally (åœ¨æœ¬åœ°è¿›è¡Œæ›´æ”¹)
            2. Commit: \`git commit -am "Fix submission issues"\` (æäº¤)
            3. Push: \`git push origin main\` (æ¨é€)
            4. Wait for automatic validation (ç­‰å¾…è‡ªåŠ¨éªŒè¯)
            
            ---
            
            *This is automated file validation. Your instructor will manually review design quality and creativity.*
            
            *è¿™æ˜¯è‡ªåŠ¨æ–‡ä»¶éªŒè¯ã€‚è®²å¸ˆå°†æ‰‹åŠ¨å®¡æŸ¥è®¾è®¡è´¨é‡å’Œåˆ›æ„ã€‚*
            `;
            
            // Check if feedback issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['file-validation', 'feedback']
            });
            
            if (issues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: feedback
              });
              console.log(`âœ… Updated feedback issue #${issues.data[0].number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `${emoji} File Validation Feedback | æ–‡ä»¶éªŒè¯åé¦ˆ`,
                body: feedback,
                labels: ['file-validation', 'feedback']
              });
              console.log(`âœ… Created feedback issue #${issue.data.number}`);
            }


